// AUTO-GENERATED - DO NOT EDIT
// Edit colors.yaml and run: npm run build

// Hex -> display name
const hexToName = {
  "191970": "midnightblue",
  "663399": "rebeccapurple",
  "696969": "dimgray",
  "708090": "slategray",
  "778899": "lightslategray",
  "800000": "maroon",
  "800080": "purple",
  "808000": "olive",
  "808080": "gray",
  "001ced": "iced",
  "4b61d1": "savoy blue",
  "f0f8ff": "aliceblue",
  "faebd7": "antiquewhite",
  "7fffd4": "aquamarine",
  "f0ffff": "azure",
  "f5f5dc": "beige",
  "ffe4c4": "bisque",
  "000000": "black",
  "ffebcd": "blanchedalmond",
  "0000ff": "blue",
  "8a2be2": "blueviolet",
  "a52a2a": "brown",
  "deb887": "burlywood",
  "5f9ea0": "cadetblue",
  "7fff00": "chartreuse",
  "d2691e": "chocolate",
  "ff7f50": "coral",
  "6495ed": "cornflowerblue",
  "fff8dc": "cornsilk",
  "dc143c": "crimson",
  "00ffff": "cyan",
  "00008b": "darkblue",
  "008b8b": "darkcyan",
  "b8860b": "darkgoldenrod",
  "a9a9a9": "darkgray",
  "006400": "darkgreen",
  "bdb76b": "darkkhaki",
  "8b008b": "darkmagenta",
  "556b2f": "darkolivegreen",
  "ff8c00": "darkorange",
  "9932cc": "darkorchid",
  "8b0000": "darkred",
  "e9967a": "darksalmon",
  "8fbc8f": "darkseagreen",
  "483d8b": "darkslateblue",
  "2f4f4f": "darkslategray",
  "00ced1": "darkturquoise",
  "9400d3": "darkviolet",
  "ff1493": "deeppink",
  "00bfff": "deepskyblue",
  "1e90ff": "dodgerblue",
  "b22222": "firebrick",
  "fffaf0": "floralwhite",
  "228b22": "forestgreen",
  "dcdcdc": "gainsboro",
  "f8f8ff": "ghostwhite",
  "ffd700": "gold",
  "daa520": "goldenrod",
  "008000": "green",
  "adff2f": "greenyellow",
  "f0fff0": "honeydew",
  "ff69b4": "hotpink",
  "cd5c5c": "indianred",
  "4b0082": "indigo",
  "fffff0": "ivory",
  "f0e68c": "khaki",
  "e6e6fa": "lavender",
  "fff0f5": "lavenderblush",
  "7cfc00": "lawngreen",
  "fffacd": "lemonchiffon",
  "add8e6": "lightblue",
  "f08080": "lightcoral",
  "e0ffff": "lightcyan",
  "fafad2": "lightgoldenrodyellow",
  "d3d3d3": "lightgray",
  "90ee90": "lightgreen",
  "ffb6c1": "lightpink",
  "ffa07a": "lightsalmon",
  "20b2aa": "lightseagreen",
  "87cefa": "lightskyblue",
  "b0c4de": "lightsteelblue",
  "ffffe0": "lightyellow",
  "00ff00": "lime",
  "32cd32": "limegreen",
  "faf0e6": "linen",
  "ff00ff": "magenta",
  "66cdaa": "mediumaquamarine",
  "0000cd": "mediumblue",
  "ba55d3": "mediumorchid",
  "9370db": "mediumpurple",
  "3cb371": "mediumseagreen",
  "7b68ee": "mediumslateblue",
  "00fa9a": "mediumspringgreen",
  "48d1cc": "mediumturquoise",
  "c71585": "mediumvioletred",
  "f5fffa": "mintcream",
  "ffe4e1": "mistyrose",
  "ffe4b5": "moccasin",
  "ffdead": "navajowhite",
  "000080": "navy",
  "fdf5e6": "oldlace",
  "6b8e23": "olivedrab",
  "ffa500": "orange",
  "ff4500": "orangered",
  "da70d6": "orchid",
  "eee8aa": "palegoldenrod",
  "98fb98": "palegreen",
  "afeeee": "paleturquoise",
  "db7093": "palevioletred",
  "ffefd5": "papayawhip",
  "ffdab9": "peachpuff",
  "cd853f": "peru",
  "ffc0cb": "pink",
  "dda0dd": "plum",
  "b0e0e6": "powderblue",
  "ff0000": "red",
  "bc8f8f": "rosybrown",
  "4169e1": "royalblue",
  "8b4513": "saddlebrown",
  "fa8072": "salmon",
  "f4a460": "sandybrown",
  "2e8b57": "seagreen",
  "fff5ee": "seashell",
  "a0522d": "sienna",
  "c0c0c0": "silver",
  "87ceeb": "skyblue",
  "6a5acd": "slateblue",
  "fffafa": "snow",
  "00ff7f": "springgreen",
  "4682b4": "steelblue",
  "d2b48c": "tan",
  "008080": "teal",
  "d8bfd8": "thistle",
  "ff6347": "tomato",
  "40e0d0": "turquoise",
  "ee82ee": "violet",
  "f5deb3": "wheat",
  "ffffff": "white",
  "f5f5f5": "whitesmoke",
  "ffff00": "yellow",
  "9acd32": "yellowgreen"
};

// Name -> hex (includes aliases)
const nameToHex = {
  "iced": "001ced",
  "savoy blue": "4b61d1",
  "aliceblue": "f0f8ff",
  "antiquewhite": "faebd7",
  "aquamarine": "7fffd4",
  "azure": "f0ffff",
  "beige": "f5f5dc",
  "bisque": "ffe4c4",
  "black": "000000",
  "blanchedalmond": "ffebcd",
  "blue": "0000ff",
  "blueviolet": "8a2be2",
  "brown": "a52a2a",
  "burlywood": "deb887",
  "cadetblue": "5f9ea0",
  "chartreuse": "7fff00",
  "chocolate": "d2691e",
  "coral": "ff7f50",
  "cornflowerblue": "6495ed",
  "cornsilk": "fff8dc",
  "crimson": "dc143c",
  "cyan": "00ffff",
  "aqua": "00ffff",
  "darkblue": "00008b",
  "darkcyan": "008b8b",
  "darkgoldenrod": "b8860b",
  "darkgray": "a9a9a9",
  "darkgreen": "006400",
  "darkkhaki": "bdb76b",
  "darkmagenta": "8b008b",
  "darkolivegreen": "556b2f",
  "darkorange": "ff8c00",
  "darkorchid": "9932cc",
  "darkred": "8b0000",
  "darksalmon": "e9967a",
  "darkseagreen": "8fbc8f",
  "darkslateblue": "483d8b",
  "darkslategray": "2f4f4f",
  "darkturquoise": "00ced1",
  "darkviolet": "9400d3",
  "deeppink": "ff1493",
  "deepskyblue": "00bfff",
  "dimgray": "696969",
  "dodgerblue": "1e90ff",
  "firebrick": "b22222",
  "floralwhite": "fffaf0",
  "forestgreen": "228b22",
  "gainsboro": "dcdcdc",
  "ghostwhite": "f8f8ff",
  "gold": "ffd700",
  "goldenrod": "daa520",
  "gray": "808080",
  "green": "008000",
  "greenyellow": "adff2f",
  "honeydew": "f0fff0",
  "hotpink": "ff69b4",
  "indianred": "cd5c5c",
  "indigo": "4b0082",
  "ivory": "fffff0",
  "khaki": "f0e68c",
  "lavender": "e6e6fa",
  "lavenderblush": "fff0f5",
  "lawngreen": "7cfc00",
  "lemonchiffon": "fffacd",
  "lightblue": "add8e6",
  "lightcoral": "f08080",
  "lightcyan": "e0ffff",
  "lightgoldenrodyellow": "fafad2",
  "lightgray": "d3d3d3",
  "lightgreen": "90ee90",
  "lightpink": "ffb6c1",
  "lightsalmon": "ffa07a",
  "lightseagreen": "20b2aa",
  "lightskyblue": "87cefa",
  "lightslategray": "778899",
  "lightsteelblue": "b0c4de",
  "lightyellow": "ffffe0",
  "lime": "00ff00",
  "limegreen": "32cd32",
  "linen": "faf0e6",
  "magenta": "ff00ff",
  "fuchsia": "ff00ff",
  "maroon": "800000",
  "mediumaquamarine": "66cdaa",
  "mediumblue": "0000cd",
  "mediumorchid": "ba55d3",
  "mediumpurple": "9370db",
  "mediumseagreen": "3cb371",
  "mediumslateblue": "7b68ee",
  "mediumspringgreen": "00fa9a",
  "mediumturquoise": "48d1cc",
  "mediumvioletred": "c71585",
  "midnightblue": "191970",
  "mintcream": "f5fffa",
  "mistyrose": "ffe4e1",
  "moccasin": "ffe4b5",
  "navajowhite": "ffdead",
  "navy": "000080",
  "oldlace": "fdf5e6",
  "olive": "808000",
  "olivedrab": "6b8e23",
  "orange": "ffa500",
  "orangered": "ff4500",
  "orchid": "da70d6",
  "palegoldenrod": "eee8aa",
  "palegreen": "98fb98",
  "paleturquoise": "afeeee",
  "palevioletred": "db7093",
  "papayawhip": "ffefd5",
  "peachpuff": "ffdab9",
  "peru": "cd853f",
  "pink": "ffc0cb",
  "plum": "dda0dd",
  "powderblue": "b0e0e6",
  "purple": "800080",
  "rebeccapurple": "663399",
  "red": "ff0000",
  "rosybrown": "bc8f8f",
  "royalblue": "4169e1",
  "saddlebrown": "8b4513",
  "salmon": "fa8072",
  "sandybrown": "f4a460",
  "seagreen": "2e8b57",
  "seashell": "fff5ee",
  "sienna": "a0522d",
  "silver": "c0c0c0",
  "skyblue": "87ceeb",
  "slateblue": "6a5acd",
  "slategray": "708090",
  "snow": "fffafa",
  "springgreen": "00ff7f",
  "steelblue": "4682b4",
  "tan": "d2b48c",
  "teal": "008080",
  "thistle": "d8bfd8",
  "tomato": "ff6347",
  "turquoise": "40e0d0",
  "violet": "ee82ee",
  "wheat": "f5deb3",
  "white": "ffffff",
  "whitesmoke": "f5f5f5",
  "yellow": "ffff00",
  "yellowgreen": "9acd32"
};

export async function onRequest(context) {
  const { request, env } = context;
  const url = new URL(request.url);

  // Handle counter endpoints
  if (url.pathname === '/counter/get') {
    return handleCounterGet(env);
  }

  if (url.pathname === '/counter/hit') {
    return handleCounterHit(env, request);
  }

  // For index requests or color paths, inject dynamic meta tags
  const isIndexPath = url.pathname === '/app.html' || url.pathname === '/';
  const isPotentialColorPath = !isIndexPath && !url.pathname.startsWith('/counter/') && !url.pathname.startsWith('/preview') && !url.pathname.startsWith('/functions/') && !url.pathname.startsWith('/index.');

  if (isIndexPath || isPotentialColorPath) {
    const queryString = url.search.slice(1);
    let colorParam = queryString;

    if (!colorParam && isPotentialColorPath) {
      colorParam = decodeURIComponent(url.pathname.slice(1));
    }

    if (colorParam) {
      const firstParam = colorParam.split('&')[0];
      let hex = tryParseColor(firstParam);

      if (hex) {
        const appUrl = new URL('/app.html', request.url);
        const response = await env.ASSETS.fetch(appUrl);
        let html = await response.text();

        const colorName = hexToName[hex];
        const r = parseInt(hex.slice(0,2),16);
        const g = parseInt(hex.slice(2,4),16);
        const b = parseInt(hex.slice(4,6),16);

        const colorInfo = colorName
          ? `${colorName} • #${hex.toUpperCase()} • rgb(${r}, ${g}, ${b})`
          : `#${hex.toUpperCase()} • rgb(${r}, ${g}, ${b})`;

        const title = `${colorInfo} • hex to rgb like it's 1999`;

        const imageUrl = `https://hexrgb.pages.dev/preview.png?color=${hex}`;
        html = html.replace(
          /<title>[^<]*<\/title>/,
          `<title>${title}</title>`
        );
        html = html.replace(
          /<meta property="og:image" content="[^"]*">/,
          `<meta property="og:image" content="${imageUrl}">`
        );
        html = html.replace(
          /<meta name="twitter:image" content="[^"]*">/,
          `<meta name="twitter:image" content="${imageUrl}">`
        );
        html = html.replace(
          /<meta property="og:description" content="[^"]*">/,
          `<meta property="og:description" content="${colorInfo}">`
        );

        return new Response(html, {
          headers: {
            'Content-Type': 'text/html; charset=utf-8',
          }
        });
      }
    }
  }

  if (url.pathname === '/' || url.pathname === '/app.html') {
    const appUrl = new URL('/app.html', request.url);
    return env.ASSETS.fetch(appUrl);
  }

  return context.next();
}

// Try to parse input as hex code first, then as color name
function tryParseColor(input) {
  // Clean prefix
  let cleaned = input.replace(/^0x/i, '').replace(/^#/, '');

  // 1. If input is ONLY hex chars, treat as hex code (highest priority)
  if (/^[0-9a-f]{3}$/i.test(cleaned)) {
    return (cleaned[0] + cleaned[0] + cleaned[1] + cleaned[1] + cleaned[2] + cleaned[2]).toLowerCase();
  }
  if (/^[0-9a-f]{6}$/i.test(cleaned)) {
    return cleaned.toLowerCase();
  }

  // 2. Try as color name
  return lookupColorName(input);
}

// Lookup color name with fuzzy matching
function lookupColorName(input) {
  const normalized = input.toLowerCase().trim();

  // Exact match
  if (nameToHex[normalized]) {
    return nameToHex[normalized];
  }

  // Strip - and _ and try again
  const stripped = normalized.replace(/[-_]/g, '');
  if (nameToHex[stripped]) {
    return nameToHex[stripped];
  }

  // Check all keys with normalization
  for (const [name, hex] of Object.entries(nameToHex)) {
    if (name.replace(/[-_ ]/g, '') === stripped) {
      return hex;
    }
  }

  // startsWith match (only if unambiguous)
  const matches = Object.entries(nameToHex).filter(([name]) =>
    name.replace(/[-_ ]/g, '').startsWith(stripped)
  );
  if (matches.length === 1) {
    return matches[0][1];
  }

  return null;
}

async function handleCounterGet(env) {
  try {
    const count = await env.HEX_STORAGE.get('visitor_count');
    const value = count ? parseInt(count) : 0;

    return new Response(JSON.stringify({ value }), {
      headers: {
        'Content-Type': 'application/json',
        'Access-Control-Allow-Origin': '*',
      }
    });
  } catch (error) {
    return new Response(JSON.stringify({ error: error.message, value: 0 }), {
      status: 500,
      headers: {
        'Content-Type': 'application/json',
        'Access-Control-Allow-Origin': '*',
      }
    });
  }
}

async function handleCounterHit(env, request) {
  try {
    const ip = request.headers.get('CF-Connecting-IP') || 'unknown';
    const ipKey = `ip_${ip}`;

    const lastVisit = await env.HEX_STORAGE.get(ipKey);
    const now = Date.now();

    if (lastVisit && (now - parseInt(lastVisit)) < 3600000) {
      const count = await env.HEX_STORAGE.get('visitor_count');
      const currentValue = count ? parseInt(count) : 0;

      return new Response(JSON.stringify({ value: currentValue, cached: true }), {
        headers: {
          'Content-Type': 'application/json',
          'Access-Control-Allow-Origin': '*',
        }
      });
    }

    const count = await env.HEX_STORAGE.get('visitor_count');
    const currentValue = count ? parseInt(count) : 0;
    const newValue = currentValue + 1;

    await env.HEX_STORAGE.put('visitor_count', newValue.toString());
    await env.HEX_STORAGE.put(ipKey, now.toString(), { expirationTtl: 3600 });

    return new Response(JSON.stringify({ value: newValue }), {
      headers: {
        'Content-Type': 'application/json',
        'Access-Control-Allow-Origin': '*',
      }
    });
  } catch (error) {
    return new Response(JSON.stringify({ error: error.message, value: 0 }), {
      status: 500,
      headers: {
        'Content-Type': 'application/json',
        'Access-Control-Allow-Origin': '*',
      }
    });
  }
}
